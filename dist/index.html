<!DOCTYPE html>
<html lang=en-US dir=ltr>
  	<head>
		<meta charset=utf-8>

		<title>Aces</title>
		<meta name=description content='Arcadia High School App Content Editing System'>
		<meta name=author content='Xing Liu'>
		<meta name=viewport content='width=device-width, initial-scale=1.0'>

		<link rel=icon type=image/png href=/icon.png>
		<style>
#sign-in {
	position: fixed;
	top: 8pt;
	right: 8pt;

	width: 24rem;
	max-width: 100%;

	display: flex;
	flex-direction: column;
	
	background:var(--background-color);
	z-index: 10;

	box-shadow: 0 0 0 100vmax #0004;
}
#sign-in:not(:focus):not(:focus-within){
	pointer-events: none;
	opacity: 0;
}
#sign-in .cancel {
	background: transparent;
	border: 0;
}
#sign-in > * + * {
	margin-top: 8pt;
}
#sign-in.loading{
	border-color: blue;
}
#sign-in.invalid{
	border-color: red;
}

input[disabled] {
	display: none;
}

#browser {
	flex: 1;
	scroll-behavior: smooth;
}
#browser .title{
	scroll-margin: 4rem;
	text-decoration: none;
	flex-grow: 1;
}
.group > header {
	display: flex;
	gap: 8pt;
}
.group > header > label:first-child {
	flex-grow: 1;
}
.group > header > label:last-child {
	flex-basis: 4rem;
}
.group.location > header .title {
	font-size: 2rem;
}
.group.category {
	margin-top: 1rem;
}
.group.category > header {
	grid-column: 1 / -1;
}
.group.category > header .title{
	font-size: 1.5rem;
}
#browser > section > section {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr));
	grid-auto-rows: auto;
	grid-gap: 8pt;
	scroll-margin-top: 1rem;
}
#browser > header {
	flex-wrap: wrap;
}
#browser > header > #search {
	width: 0;
	flex-grow: 1;
}

.card {
	border-radius: var(--radius);
	padding: 8pt;
	background: transparent;
	transition-duration: 100ms;
	border: var(--border);
	border-color: var(--border-color);
}
.card:hover:not(header) {
	border-color: var(--hover-color);
}
.card:focus,
.card:focus-within:not(header),
.card.open {
	border-color: var(--text-color);
}
.card.changed,
.card.changed:hover,
.card.changed:focus-within {
	border-color: var(--success-color);
	border-style: dashed;
}
.card.info {
	display: flex;
	flex-direction: column;
}
.card.info > :first-child {
	overflow-wrap: break-word;
	flex-grow: 1;
}
.card > .menu {
	display: flex;
	margin-top: 8pt;
	padding-top: 8pt;
	gap: 8pt;
	border-top: var(--border);
}
.card > .menu > * {
	width: 1rem;
	height: 1rem;
	padding: 0;
}
.card > .menu > .action > input {
	display: none;
}
#editor {
	grid-template-columns: repeat(2, minmax(0, 1fr));
	width: 36vw;
	padding-top: 1rem;
}
#editor > * {
	grid-column-end: span 2;
}
#editor > label[half-width] {
	grid-column-end: span 1;
}
#editor header > * {
	flex: 1 0 0;
	width: 0;
}
header > [type=button] {
	cursor: pointer;
	text-decoration: none;
	color:var(--text-color);
}

#editor > label > #title {
	font-size: 1.6rem;
}
#editor > label > #author {
	font-size: 1rem;
}
#editor > label > #media {
	display: flex;
	overflow-x: scroll;
}
#media > .thumb {
	cursor: move;
	margin-right: 8pt;
	flex: 0 0 10rem;
	height: 12rem;
	width: 8rem;
}
.thumb > img {
	object-fit: contain;
	object-position: center;
	max-height: 100%;
	pointer-events: none;
	height: 8rem;
}
@font-face {
	font-family: 'pt-root';
	src: url('pt-root.woff2') format('woff2');
	font-weight: normal;
	font-style: normal;
	font-display: swap;
}
.markdown {
	position: relative;
}
.markdown .bold {
	font-weight: 700;
}
.markdown .italic {
	font-style: italic;
}
.markdown .strikethrough {
	text-decoration: line-through;
}
.markdown .link {
	color: var(--link-color);
}
.markdown .list {
	background: linear-gradient(90deg, #ff08,transparent 2ch);
}
.markdown .heading {
	font-weight: 700;
	display: inline-block;
	width: 100%;
	background: #8882;
}
/* TextareaDecorator.css
 * written by Colin Kuebler 2012
 * Part of LDT, dual licensed under GPLv3 and MIT
 * Provides styles for rendering a textarea on top of a pre with scrollbars
 */
.markdown code, .markdown textarea {
	font-size: 1rem;
	font-family: inherit;
}

.markdown {
	overflow: hidden;
	position: relative;
}

.markdown > code {
	margin: 0;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}
.markdown > textarea {
	/* hide the text but show the text caret */
	color: transparent !important;
	caret-color: var(--text-color);
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	border: 0;
	padding: inherit;
	cursor: text;
	background: transparent;
}
label.card{
	position: relative;
	padding: 0;
	display: block;
}
label.card:hover > span{
	color: var(--hover-color);
}
label.card:focus-within > span{
	color: var(--text-color);
}
label.card.changed > span,
label.card.changed:hover > span,
label.card.changed:focus-within > span {
	color: var(--success-color);
}
label.card > span {
	position: absolute;
	top: -0.5rem;
	left: 0.3rem;
	text-transform: lowercase;
	font-size: .8rem;
	padding-inline: .2ch;
	font-weight: 700;
	background: var(--background-color);
	color: var(--border-color);
	max-width: 100%;
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
}
label.card > :last-child {
	border: 0;
	padding: 8pt;
	width: 100%;
	height: 100%;
	background: transparent;
}
label.card > * {
	margin: 0;
	border-radius: var(--radius);
}
label.card ::placeholder {
	color: #888;
}
label.card textarea{
	resize: none;
}
input::placeholder {
	color: var(--hover-color)
}
:root{
	--radius: 4pt;
	--border-color: #ccc;
	--hover-color: #888;
	--link-color: #248;
	--success-color: #2a8;
	--border: solid 2pt var(--border-color);
	--background-color: white;
	--cover: #fffd;
	--text-color: black;
}

@media (prefers-color-scheme: dark) { :root {
	--border-color: hsl(220deg,20%,20%);
	--hover-color: hsl(220deg,20%,40%);
	--link-color: #8af;
	--success-color: #8fa;
	--background-color: hsl(220deg,20%,8%);
	--cover: #000d;
	--text-color: #ddd;
} }

html {
	font-family: 'pt-root', Sans-serif;
	font-weight: 400;
	font-size: 14pt;
	touch-action: pan-x;
	overscroll-behavior-x: none; /* Prevent Chrome swipe navigation */
}
body {
	display: flex;
	background: var(--background-color);
}
body * {
	box-sizing: border-box;
	color: var(--text-color);
	overflow-wrap: break-word;
}
body:not(input):not(textarea){
	user-select: none;
}
body :focus{
	outline: 0;
}
h1,h2,h3,h4,h5,h6 {
	font-weight: 400;
	margin: 0;
	padding: 0;
}

button,
[type=button],
[type=submit] {
  cursor: pointer;
}

[hidden]{
	display: none !important;
}
/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */

/* Document
========================================================================== */

/**
* 1. Correct the line height in all browsers.
* 2. Prevent adjustments of font size after orientation changes in iOS.
*/

html {
	line-height: 1.35; /* 1 */
	-webkit-text-size-adjust: 100%; /* 2 */
}

/* Sections
========================================================================== */

/**
* Remove the margin in all browsers.
*/

body {
	margin: 0;
}

/**
* Render the `main` element consistently in IE.
*/

main {
	display: block;
}

/**
* Correct the font size and margin on `h1` elements within `section` and
* `article` contexts in Chrome, Firefox, and Safari.
*/

h1 {
	font-size: 2em;
}

/* Grouping content
========================================================================== */

/**
* 1. Add the correct box sizing in Firefox.
* 2. Show the overflow in Edge and IE.
*/

hr {
	box-sizing: content-box; /* 1 */
	height: 0; /* 1 */
	overflow: visible; /* 2 */
}

/**
* 1. Correct the inheritance and scaling of font size in all browsers.
* 2. Correct the odd `em` font sizing in all browsers.
*/

pre {
	font-family: monospace, monospace; /* 1 */
	font-size: 1em; /* 2 */
}

/* Text-level semantics
========================================================================== */

/**
* Remove the gray background on active links in IE 10.
*/

a {
	background-color: transparent;
}

/**
* 1. Remove the bottom border in Chrome 57-
* 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari.
*/

abbr[title] {
	border-bottom: none; /* 1 */
	text-decoration: underline; /* 2 */
	text-decoration: underline dotted; /* 2 */
}

/**
* Add the correct font weight in Chrome, Edge, and Safari.
*/

b,
strong {
	font-weight: 700;
}

/**
* 1. Correct the inheritance and scaling of font size in all browsers.
* 2. Correct the odd `em` font sizing in all browsers.
*/

code,
kbd,
samp {
	font-family: monospace, monospace; /* 1 */
	font-size: 1em; /* 2 */
}

/**
* Add the correct font size in all browsers.
*/

small {
	font-size: 80%;
}

/**
* Prevent `sub` and `sup` elements from affecting the line height in
* all browsers.
*/

sub,
sup {
	font-size: 75%;
	line-height: 0;
	position: relative;
	vertical-align: baseline;
}

sub {
	bottom: -0.25em;
}

sup {
	top: -0.5em;
}

/* Embedded content
========================================================================== */

/**
* Remove the border on images inside links in IE 10.
*/

img {
	border-style: none;
}

/* Forms
========================================================================== */

/**
* 1. Change the font styles in all browsers.
* 2. Remove the margin in Firefox and Safari.
*/

button,
input,
optgroup,
select,
textarea {
	font-family: inherit; /* 1 */
	font-size: 100%; /* 1 */
	line-height: 1.35; /* 1 */
	margin: 0; /* 2 */
}

/**
* Show the overflow in IE.
* 1. Show the overflow in Edge.
*/

button,
input { /* 1 */
	overflow: visible;
}

/**
* Remove the inheritance of text transform in Edge, Firefox, and IE.
* 1. Remove the inheritance of text transform in Firefox.
*/

button,
select { /* 1 */
	text-transform: none;
}

/**
* Correct the inability to style clickable types in iOS and Safari.
*/

button,
[type="button"],
[type="reset"],
[type="submit"] {
	-webkit-appearance: button;
}

/**
* Remove the inner border and padding in Firefox.
*/

button::-moz-focus-inner,
[type="button"]::-moz-focus-inner,
[type="reset"]::-moz-focus-inner,
[type="submit"]::-moz-focus-inner {
	border-style: none;
	padding: 0;
}

/**
* Restore the focus styles unset by the previous rule.
*/

button:-moz-focusring,
[type="button"]:-moz-focusring,
[type="reset"]:-moz-focusring,
[type="submit"]:-moz-focusring {
	outline: 1px dotted ButtonText;
}

/**
* Correct the padding in Firefox.
*/

fieldset {
	padding: 0.35em 0.75em 0.625em;
}

/**
* 1. Correct the text wrapping in Edge and IE.
* 2. Correct the color inheritance from `fieldset` elements in IE.
* 3. Remove the padding so developers are not caught out when they zero out
*    `fieldset` elements in all browsers.
*/

legend {
	box-sizing: border-box; /* 1 */
	color: inherit; /* 2 */
	display: table; /* 1 */
	max-width: 100%; /* 1 */
	padding: 0; /* 3 */
	white-space: normal; /* 1 */
}

/**
* Add the correct vertical alignment in Chrome, Firefox, and Opera.
*/

progress {
	vertical-align: baseline;
}

/**
* Remove the default vertical scrollbar in IE 10+.
*/

textarea {
	overflow: auto;
}

/**
* 1. Add the correct box sizing in IE 10.
* 2. Remove the padding in IE 10.
*/

[type="checkbox"],
[type="radio"] {
	box-sizing: border-box; /* 1 */
	padding: 0; /* 2 */
}

/**
* Correct the cursor style of increment and decrement buttons in Chrome.
*/

[type="number"]::-webkit-inner-spin-button,
[type="number"]::-webkit-outer-spin-button {
	height: auto;
}

/**
* 1. Correct the odd appearance in Chrome and Safari.
* 2. Correct the outline style in Safari.
*/

[type="search"] {
	-webkit-appearance: textfield; /* 1 */
	outline-offset: -2px; /* 2 */
}

/**
* Remove the inner padding in Chrome and Safari on macOS.
*/

[type="search"]::-webkit-search-decoration {
	-webkit-appearance: none;
}

/**
* 1. Correct the inability to style clickable types in iOS and Safari.
* 2. Change font properties to `inherit` in Safari.
*/

::-webkit-file-upload-button {
	-webkit-appearance: button; /* 1 */
	font: inherit; /* 2 */
}

/* Interactive
========================================================================== */

/*
* Add the correct display in Edge, IE 10+, and Firefox.
*/

details {
	display: block;
}

/*
* Add the correct display in all browsers.
*/

summary {
	display: list-item;
}

/* Misc
========================================================================== */

/**
* Add the correct display in IE 10+.
*/

template {
	display: none;
}

/**
* Add the correct display in IE 10.
*/

[hidden] {
	display: none;
}
.panel {
	overflow: hidden scroll;
	padding: 0 1rem;
	display: grid;
	grid-gap: 1rem;
	grid-auto-rows: 1fr;
}
.panel > header {
	position: sticky;
	display: flex;
	top: 0;
	margin-inline: -1rem;
	border-inline: 0;
	border-top: 0;
	border-radius: 0;
	height: 3rem;
	gap: 0.5rem;
	z-index: 1;
	background-color: var(--background-color);
}
.panel > header > * {
	border-radius: var(--radius);
	padding: 2pt 4pt;
	z-index: -1;
}
.panel::after{
	content: '';
	display: block;
	height: 1rem;
}
html,
body,
#resize,
.panel {
	height: 100%;
}
.preview.card{
	scroll-margin-block: 4rem;
}
.preview.open.card {
	border-style: dashed;
}
.menu > .media {
	display: contents;
}
.menu > .media > img {
	width: 1rem;
	height: 1rem;
	object-fit: contain;
	background: var(--border-color);
} 
.menu > .action {
	width: 1em;
	height: 1em;	
	cursor: pointer;
}
.menu > .action > svg {
	fill: var(--hover-color);
	width: 100%;
	height: 100%;
}
.menu > .action:hover > svg {
	fill: var(--text-color);
}
.menu > .action > input:not(:checked) + svg > :nth-child(2) {
	opacity: 0;
}
#resize {
	border-radius: 0;
	padding-block: 0;
	padding-inline: 4pt;
	font-size: .6rem;
	font-weight: 700;
	border-inline-width: 0;
	cursor: col-resize;
	writing-mode: vertical-rl;
	display: flex;
	align-items: center;
	color: var(--border-color);
	touch-action: none;
}
#resize:hover {
	color: var(--hover-color);
}
#resize:focus {
	color: var(--text-color);
}
#resize > :not(.dots) {
	color: inherit;
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
}
#resize > .dots {
	letter-spacing: 1ch;
	flex-grow: 1;
	text-align: center;
}
#resize > .author {
	transform: rotate(180deg);
}
		</style>
	</head>
	<body>
		<main id=editor class=panel>
			<label class=card id=title-label>
				<span>title</span>
				<textarea id=title accesskey=t></textarea>
			</label>
			<label class=card id=categoryID-label>
				<span>category</span>
				<select id=categoryID></select>
			</label>
			<label class=card id=title-label>
				<span>author</span>
				<textarea id=author accesskey=a></textarea>
			</label>
			<label class=card id=timestamp-label>
				<span>publication time</span>
				<input id=timestamp type=datetime-local>
			</label>
			<label class=card id=featured-label half-width><div>
				<input id=featured type=checkbox>
				feature
			</div></label>
			<label class=card id=notified-label half-width><div>
				<input id=notified type=checkbox>
				notify
			</div></label>
			<label class=card id=blurb-label>
				<span>blurb (notification body)</span>
				<textarea id=blurb></textarea>
			</label>
			<label class=card id=notifTimestamp-label>
				<span>notification time</span>
				<input id=notifTimestamp type=datetime-local>
			</label>
			<label class=card id=upload-label half-width>
				<span>upload images</span>
				<input id=upload type=file multiple accept=image/*>
			</label>
			<label class=card id=url-label half-width>
				<span>image/YouTube URL</span>
				<input id=url type=url>
			</label>
			<label class=card id=media-label>
				<span>images and videos</span>
				<section id=media>
				</section>
			</label>
			<label class=card id=markdown-label>
				<span>body (article text)</span>
				<section id=markdown-wrapper class=markdown>
					<textarea class=input id=markdown accesskey=b multi-line></textarea>
					<code class=output></code>
				</section>
			</label>
		</main>
		<div id=resize class=card tabindex=0>
			<span class=name>
				AHS App Content Editing System
			</span>
			<span class=dots>
				&bull;&bull;&bull;
			</span>
			<span class=author>
				Designed and programmed by Xing Liu
			</span>
		</div>
		<aside id=browser class=panel>
			<header class=card>
				<input type=button
					class=card
					id=new
					title='draft a new story'
					value='＋'
					accesskey=n >
				<input type=text
					class=card
					id=search
					title='search articles (alt+/)'
					placeholder='Search titles'
					accesskey='/'>
				<input type=button
					class=card
					id=sources
					title='view resources'
					value=🕮
					accesskey=R >
				<input type=button
					class=card
					id=sign
					title='sign in/out (alt+s)'
					value='Sign in'
					accesskey=s >
			</header>
			<!-- insert previews -->
		</aside>
		<form id=sign-in class=card tabindex=0 method=dialog>
			<label class=card>
				<span>email</span>
				<input id='email' type='email'
				autocomplete='on' spellcheck='false' required>
			</label>
			<label class=card>
				<span>password</span>
				<input id='password' type='password'
				autocomplete='on' spellcheck='false' required>
			</label>
			<input type=submit class=card value='sign in'>
			<input type=button class=cancel value='✕'>
		</form>
		<!-- TEMPLATES -->
		<template id='template-location'>
			<section class='group location'>
				<header>
					<label class='card'>
						<span>location title</span>
						<textarea class='title input'></textarea>
					</label>
					<a class='id' hidden></a>
				</header>
			</section>
		</template>
		<template id='template-category'>
			<section class='group category'>
				<header>
					<label class='card'>
						<span>category title</span>
						<textarea class='title input'></textarea>
					</label>
					<a class='id' hidden></a>
					<label class='card'>
						<span>color</span>
						<input type='color' class='color'>
					</label>
				</header>
			</section>
		</template>
		<template id='template-preview'>
			<article class='preview info card'>
				<a class='title'></a>
				<section class=menu>
					<label title='feature/unfeature (f)' class='action toggle'>
						<input type=checkbox class=featured>
						<svg viewBox='0 0 24 24' width='24' height='24'>
							<path d='M19.65 9.04l-4.84-.42-1.89-4.45c-.34-.81-1.5-.81-1.84 0L9.19 8.63l-4.83.41c-.88.07-1.24 1.17-.57 1.75l3.67 3.18-1.1 4.72c-.2.86.73 1.54 1.49 1.08l4.15-2.5 4.15 2.51c.76.46 1.69-.22 1.49-1.08l-1.1-4.73 3.67-3.18c.67-.58.32-1.68-.56-1.75zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z'/>
							<path d='M12 17.27l5.17 3.12c.38.23.85-.11.75-.54l-1.37-5.88 4.56-3.95c.33-.29.16-.84-.29-.88l-6.01-.51-2.35-5.54c-.17-.41-.75-.41-.92 0L9.19 8.63l-6.01.51c-.44.04-.62.59-.28.88l4.56 3.95-1.37 5.88c-.1.43.37.77.75.54L12 17.27z'/>
						</svg>
					</label>
					<label title='move to archive (a)' class='action button' hidden>
						<input type=checkbox class=archived>
						<svg viewBox='0 0 24 24' width='24' height='24'>
							<path d='M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.81.97H5.44l.8-.97zM5 19V8h14v11H5zm8.45-9h-2.9v3H8l4 4 4-4h-2.55z'/>		<path d='M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z'/>
						</svg>
					</label>
					<label class=media></label>
				</section>
			</article>
		</template>
		<template id='template-thumb'>
			<section class='card info thumb' draggable='true'>
				<img>
				<section class=menu>
					<label title='move image ahead' class='action button'>
						<input type=button class=move-ahead>
						<svg viewBox='0 0 24 24' width='24' height='24'>
							<path d='M16.62 2.99c-.49-.49-1.28-.49-1.77 0L6.54 11.3c-.39.39-.39 1.02 0 1.41l8.31 8.31c.49.49 1.28.49 1.77 0s.49-1.28 0-1.77L9.38 12l7.25-7.25c.48-.48.48-1.28-.01-1.76z'/>
						</svg>
					</label>
					<label title='delete image' class='action button'>
						<input type=button class=delete>
						<svg viewBox='0 0 24 24' width='24' height='24'>
							<path d='M18.3 5.71c-.39-.39-1.02-.39-1.41 0L12 10.59 7.11 5.7c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L10.59 12 5.7 16.89c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L12 13.41l4.89 4.89c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z'/>
						</svg>
					</label>
					<label title='move image behind' class='action button'>
						<input type=button class=move-behind>
						<svg viewBox='0 0 24 24' width='24' height='24'>
							<path d='M7.38 21.01c.49.49 1.28.49 1.77 0l8.31-8.31c.39-.39.39-1.02 0-1.41L9.15 2.98c-.49-.49-1.28-.49-1.77 0s-.49 1.28 0 1.77L14.62 12l-7.25 7.25c-.48.48-.48 1.28.01 1.76z'/>						</svg>
						</svg>
					</label>
				</section>
			</section>
		</template>
		<script>
'use strict'
const DEBUG = true
const KEY = 'AIzaSyDEUekXeyIKJUreRaX78lsEYBt8JGHYmHE'
let user = ''
let token = ''
const dbObject = {}
/**
 * Initiates the authentication elements
 */
async function initAuth(){
	const $sign = $('#sign')
	const $signIn = $('#sign-in')
	const $email = $('#email')
	const $password = $('#password')

	// Try to sign in with preexisting token
	signInWithToken(localStorage.getItem('refresh_token'))

	$signIn.addEventListener('submit', event=>{
		event.preventDefault()
		signInWithEmail( $email.value, $password.value )
		$signIn.reset()
		$signIn.classList.add('loading')
	})
	$signIn.addEventListener('input', ()=>{
		$signIn.classList.remove('invalid')
	})
	$sign.addEventListener('click', event=>{
		event.preventDefault()
		user ? signOut() : $email.focus()
	})
	$('.cancel',$signIn).addEventListener('click', ()=>{
		$signIn.reset()
		document.activeElement.blur()
	})
}

/**
 * Sign in to Firebase with email and password
 * @param {string} email 
 * @param {string} password 
 */
async function signInWithEmail( email, password ) {
	const res = await googleapis(
		'identitytoolkit.googleapis.com/v1/accounts:signInWithPassword',
		{ email, password, returnSecureToken: true }
	)
	if(res.error) {
		const classes = $('#signIn').classList
		classes.remove('loading')
		classes.add('invalid')
		return
	}
	setAuth(res.idToken,res.refreshToken)
}

/**
 * Sign in to Firebase with stored refresh token
 * @param {string} refreshToken 
 */
async function signInWithToken(refreshToken) {
	if(!refreshToken) return
	const res = await googleapis(
		'securetoken.googleapis.com/v1/token',
		{ refresh_token: refreshToken, grant_type: 'refresh_token' }
	)
	if(res.error) return
	setAuth(res.id_token,res.refresh_token)
}

/**
 * Sign out of Firebase
 */
async function signOut(){
	localStorage.setItem('refresh_token','')
	token = user = ''
	updateAuth(false)
}
async function setAuth(idToken,refreshToken) {
	token = '?auth=' + idToken
	user = await getUser(idToken)
	localStorage.setItem('refresh_token',refreshToken)
	updateAuth(Boolean(user))
}
async function getUser(idToken) {
	const { users: { 0: { email } } } = await googleapis(
		'identitytoolkit.googleapis.com/v1/accounts:lookup',
		{ idToken }
	)
	return email
}
async function updateAuth(signedIn){
	document.body.classList.toggle('signed-in',signedIn)
	$('#sign').value = `Sign ${signedIn ? 'out' : 'in'}`
	document.activeElement.blur()
}
const dbBrowserResources = () => Promise.all(['locationIDs','locations','categories','snippets'].map(dbLive))
async function initBrowser(){
	dbBrowserResources()
	Object.assign(navigator.serviceWorker.subscriptionList,{
		locationsIDs: updateBrowser,
		locations: updateBrowser,
		categories: updateBrowser,
		snippets: updateBrowser,
	})
	updateBrowser()
	$('#search').addEventListener('input',({target:{value:query}})=>{
		$$('.preview>.title',$('#browser')).forEach($title=>{
			const $preview = $title.parentElement
			const show = query ? $title.textContent.toLowerCase().includes(query.toLowerCase()) : true
			show ? $preview.removeAttribute('hidden') : $preview.setAttribute('hidden','')
		})
	})
	$('#sources').addEventListener('click',async ()=>{
		Object.values(await dbOnce('sources')).forEach(
			url => window.open(url,'_blank')
		)
	})
	$('#new').addEventListener('click', async () => {
		history.pushState({},'',makeID())
		updateEditor() 
	})
}
async function updateBrowser(){
	const $browser = $('#browser')
	const [ locationIDs, locations, categories, snippets ] = await dbBrowserResources()
	$browser.replaceChildren(
		$browser.firstElementChild,
		...locationIDs
			.filter( id => (id in locations) && ('categoryIDs' in locations[id]))
			.map( id => makeGroup('location', id, locations[id], locations[id].categoryIDs
				.filter( id => (id in categories) && ('articleIDs' in categories[id]) )
				.map( id => makeGroup('category', id, categories[id], categories[id].articleIDs
					.filter( id => id in snippets )
					.map( id => makePreview(id, snippets[id])
	))))))

	$$('textarea',$browser).forEach(initTextarea)
}
function makeGroup(
	type, id,
	{ title, color },
	children,
){
	const parent = {
		'category': 'categories',
		'location': 'locations',
	}[type]

	const $group = $template(type)

	const $id = $('.id',$group)
	$id.id = id
	$id.href = '#'+id
	$id.innerHTML = '#'+id

	const $title = $('.title',$group)
	$title.value = title
	addChangeListener($title, ({ target: { value: title } }) => [
		dbWrite(parent+'/'+id, { title }),
		discord('#'+id, `➡️ \`${bracket(id,type)}\` ${ title }`),
	])

	if(type=='category'){
		const $color = $('.color',$group) 
		$color.value = color
		addChangeListener($color, ({ target: { value: color } }) => [
			dbWrite(parent+'/'+id, { color }),
			discord('#'+id, `🎨 \`${ bracket(id,type) }\` ${ color }`),
		])
	}

	$group.append(...children)

	return $group
}

function makePreview(id,snippet){
	const $preview = $template('preview')

	$preview.id = 'preview-'+id

	const $title = $('.title',$preview)
	$title.addEventListener('click',async (event) => {
		document.title = snippet.title
		history.pushState({}, '', id)
		updateEditor()
		event.preventDefault()		
	})
	$title.href = id

	const $featured = $('.featured',$preview)
	addChangeListener($featured, async ({ target: { checked: featured } }) => [
		dbWrite('snippets/'+id,{featured}),
		dbWrite('articles/'+id,{featured}),
		discord(id,(featured ? '⭐ ' : '💔 ') + snippet.title)
	])

	const $archived = $('.archived',$preview)
	addChangeListener($archived, async ({ target: { checked: archived } }) => [
		discord(id,(archived ? '🗄️ ' : '♻️ ') + snippet.title)
	])

	updatePreview($preview,snippet)

	return $preview
}

function updatePreview($preview,snippet){
	$('.title',$preview).innerHTML = snippet.title
	$('.featured',$preview).checked = snippet.featured
	$('.media',$preview).replaceChildren(...(snippet.thumbURLs||[]).map(thumbURL=>{
		const $img = document.createElement('img')
		$img.src = thumbURL
		return $img
	}))
}
/**
 * Sends a message to the Discord webhook
 * @param {string} id 
 * @param {string} title 
 * @param {string} description 
 */
async function discord(id='',title='',description=''){
	post((await dbOnce('secrets/webhook')),{
		username: 'Aces',
		avatar_url: 'https://edit.ahs.app/icon.png',
		content: '',
		embeds: [{
			color: 0x995eff,
			author: {
				name: user.slice(0,256),
			},
			url: 'https://edit.ahs.app/'+id,
			title: title.slice(0,256),
			description: description.slice(0,2048),
		}],
	})
}
/**
 * Shortcut for querySelector
 * @param {string} query 
 * @param {Element} parent 
 * @returns {Element}
 */
const $ = (query,parent=document) => parent.querySelector(query)

/**
 * Shortcut for querySelectorAll
 * @param {string} query 
 * @param {Element} parent 
 * @returns {Element[]}
 */
const $$ = (query,parent=document) => Array.from(parent.querySelectorAll(query))

/**
 * Clones a template element
 * @param {string} id
 * @returns {Element}
 */
const $template = id => $('#template-'+id).content.cloneNode(true).querySelector('*')

/**
 * Adds a change event listener that also displays success
 * @param {Element} $element 
 * @param {callback} callback 
 */
const addChangeListener = async ($element, callback) =>
	$element.addEventListener( 'change', async event => {
		let $displayer = event.target
		do $displayer = $displayer.parentElement
		while ( !$displayer.classList.contains('card') )
		$displayer.classList.add('changed')
		await Promise.all(await callback(event))
		$displayer.classList.remove('changed')
	})

/**
 * Initiates the editor panel
 */
async function initEditor() {
	const $editor = $('#editor')
	const $media = $('#media')
	const $categoryID = $('#categoryID')
	const $$textarea = $$('textarea',$editor)
	const $url = $('#url')
	const $markdownWrapper = $('#markdown-wrapper')

	addChangeListener($editor, async ({target}) => {
		switch(target.id){
			case 'upload':
				const urlSets = await Promise.all(Array.from(target.files).map(imgbb))
				$media.prepend(...urlSets.map($thumb))
				break
			case 'url':
				$media.prepend($thumb(await imgbb(target.value)))
				break
		}
		return publishStory()
	})

	initHighlighter($markdownWrapper)
	$$textarea.forEach(initTextarea)
	remapEnter($url)
	
	const [locationIDs,locations,categories] = await Promise.all([
		dbCache('locationIDs'),dbLive('locations'),dbLive('categories')
	])
	$categoryID.replaceChildren(...locationIDs.filter(id=>id in locations).map(id=>{
		const $group = document.createElement('optgroup')
		$group.setAttribute('label',locations[id].title)
		$group.append(...locations[id].categoryIDs.filter(id=>id in categories).map(id=>{
			const $option = document.createElement('option')
			$option.value = id
			$option.textContent = categories[id].title
			return $option
		}))
		return $group
	}))	

	updateEditor()
	window.addEventListener('popstate',updateEditor)
}

/**
 * Create a template story from the schemas.
 * @returns {Object} story
 */
async function storyTemplate(){
	const schema = (await dbCache('schemas')).story
	const template = {}
	for (const key in schema)
		template[key] = {
			'Array<String>': [],
			'String': '',
			'Boolean': false,
			'Int': 0,
		}[schema[key]]
	return {
		...template,
		...{
			title: 'Untitled Article',
			author: 'Content Editors',
			timestamp: timestamp(),
			notifTimestamp: timestamp(),
			categoryID: 'Drafts',
			blurb: 'Notification text.',
			markdown: 'A *quick* brown **fox** jumps over a lazy [dog](https://en.wikipedia.org/wiki/Dog).'
		}
	}
}

/**
 * Update the editor with a new article ID from the URL
 */
async function updateEditor() {
	const id = urlID()
	history.replaceState({}, '', id)
	let story = await dbOnce('storys/' + id) || {}
	story = {...await storyTemplate(),...story}
	document.title = story.title
	syncStory(story,0)
	$$('#editor textarea').forEach(dispatchInput)
	$$('.preview.open').forEach($preview=>$preview.classList.remove('open'))
	const $preview = $('#preview-'+id)
	$preview.classList.add('open')
	$preview.scrollIntoView()
}

/**
 * Get the address of a category in a legacy database
 * @param {string} categoryID 
 * @returns {string}
 */
async function legacyAddress(categoryID){
	return Object.entries(await dbLive('locations')).find(
		([,{categoryIDs}]) => categoryIDs.includes(categoryID)
	)[0] + '/' + categoryID
}

/**
 * Encode a story into the URL parameters string
 * @param {Object} story
 */
async function encodeStory(story){
	const params = new URLSearchParams(window.location.search)
	params.set('story',encodeURIComponent(JSON.stringify(story)))
	history.replaceState({}, '', `${id}?${params}`)
}

/**
 * Publish a story into the database
 * @returns {Promise[]} tasks
 */
async function publishStory(){
	if(!user) return []
	const tasks = []

	const id = urlID()
	const templateStory = await storyTemplate()
	const story = await syncStory( templateStory, 1 )

	const oldStory = { ...templateStory, ... await dbOnce('storys/'+id) }
	const changes = diff(oldStory,story)
	const formattedChanges = formattedDiff(oldStory,story)
	
	for(const type of ['story','article','snippet','notif']){
		if(type==='notif' && !story.notified) continue
		const keys = Object.keys((await dbCache('schemas'))[type])
		const object = Object.fromEntries(
			Object.entries(story).filter(([key])=>keys.includes(key))
		)
		tasks.push(dbWrite(type+'s',{[id]: object}))
	}
	
	const legacyMap = (await dbCache('schemas')).legacy
	const legacyStory = {
		...Object.fromEntries(
			Object.entries(story)
			.filter(([key])=>key in legacyMap)
			.map(([key,value]) => [legacyMap[key],value])
		),
		...{
			hasHTML: true,
		}
	}
	tasks.push(dbWrite( await legacyAddress(story.categoryID), {[id]: legacyStory}, true))

	console.log(story.timestamp)
	if( changes.includes('timestamp') || changes.includes('categoryID') ){
		const categories = await dbLive('categories')
		const snippets = await dbLive('snippets')
		const siblingIDs = categories[story.categoryID].articleIDs.filter(x=>x!==id)
		const index = siblingIDs.findIndex(id=>snippets[id].timestamp < story.timestamp)
		index < 0 ? siblingIDs.push(id) : siblingIDs.splice(index,0,id)
		tasks.push( dbWrite( 'categories/'+story.categoryID, {articleIDs: siblingIDs} ) )
		if( changes.includes('categoryID') && oldStory.categoryID ) {
			const oldSiblingIDs = categories[oldStory.categoryID].articleIDs.filter(x=>x!==id)
			tasks.push(
				dbWrite( 'categories/'+oldStory.categoryID, {articleIDs: oldSiblingIDs} ),
				dbWrite( await legacyAddress(oldStory.categoryID), { [id]: null}, true ),
			)
		}
	}
	tasks.push(discord(id,'✏️ '+story.title,formattedChanges))
	return tasks
}

/**
 * Create a story object out of some data
 * @param {Object} story 
 * @param {Int} direction 0: from database, 1: from editor 
 */
async function syncStory(base,direction){
	let story = {...base}
	for(const property in story){
		const $element = $('#' + property, $('#editor'))
		if (!$element) continue
		switch ($element.type) {
			case 'checkbox':
			case 'radio':
				direction
				? story[property] = $element.checked
				: $element.checked = story[property]
				break
			case 'datetime-local':
				direction
				? story[property] = LocalISOStringToTimestamp($element.value)
				: $element.value = timestampToLocalISOString(story[property])
				break
			default:
				direction
				? story[property] = typography($element.value)
				: $element.value = story[property]
				break
		}
	}
	if(direction) {
		story.date = timestampToLocalHumanString(story.timestamp)
		story.body = md(story.markdown)
		story.videoIDs = []
		story.imageURLs = []
		story.thumbURLs = []
		$$('#media>.thumb').forEach( ({dataset}) => {
			const {thumbURL, imageURL, videoID} = JSON.parse(dataset.media)
			story.thumbURLs.push(thumbURL)
			if(imageURL) story.imageURLs.push(imageURL)
			if(videoID) story.videoIDs.push(videoID)
		})
	} else {
		const urlSets = story.thumbURLs.map(
			(thumbURL,index) =>
			({
				thumbURL,
				videoID: story.videoIDs[index],
				imageURL: story.imageURLs[index-story.videoIDs.length],
			})
		)
		$('#media').replaceChildren(...urlSets.map($thumb))
	}
	return story
}

/**
 * Create a thumbnail element from a set of image URLs
 * @param {Object} urlSet 
 * @returns {Element}
 */
function $thumb(urlSet){
	const $thumb = $template('thumb')
	const $media = $('#media')
	$thumb.dataset.media = JSON.stringify(urlSet)
	$('img',$thumb).src = urlSet.thumbURL
	$('.delete',$thumb).addEventListener('click',()=>{
		$thumb.remove()
		dispatchChange($media)
	},{once:true})
	$('.move-ahead',$thumb).addEventListener('click',()=>{
		if($thumb.previousSibling) $media.insertBefore($thumb,$thumb.previousSibling)
		dispatchChange($media)
	})
	$('.move-behind',$thumb).addEventListener('click',()=>{
		if($thumb.nextSibling) $media.insertBefore($thumb.nextSibling,$thumb)
		dispatchChange($media)
	})
	$thumb.addEventListener('dragover',event=>event.preventDefault())
	$thumb.addEventListener('dragstart',()=>$thumb.classList.add('dragged'))
	$thumb.addEventListener('drop',()=>{
		const $dragged = ('.dragged',$media)
		$dragged.classList.remove('dragged')
		$media.insertBefore($thumb,$dragged)
		dispatchChange($media)
	})
	return $thumb
}
/**
 * Initates the markdown syntax highlighter on an element
 * @param {Element} $section
 */
async function initHighlighter($section){
	const input = $('.input',$section)
	const output = $('.output',$section)
	const syntax = {
		bold: /\*\*(.+?)\*\*/gm,
		italic: /\*(.+?)\*/gm,
		strike: /~~(.+?)~~/gm,
		hr: /\s{0,3}([-+* ]{3,})$/gm,
		heading: /^#{1,6}\s(.+)$/gm,
		link: /(!?\[.*?\]\((?:https?:\/\/|mailto:).*?\)|&lt;\S+\.\S+&gt;)/gm,
		list: /^((\d+\.)|[-+*]).+$/gm,
	}
	input.addEventListener('input',async ()=>{
		let buffer = output.textContent = sanitize(input.value)
		for(const key in syntax){
			const regex = syntax[key]
			buffer = buffer.replace(regex,
				(match,p1)=>
				`<span class=${key}>${
					escape(match.slice(0,match.indexOf(p1)))
					+
					p1
					+
					escape(match.slice(match.indexOf(p1)+p1.length))
				}</span>`
			)
		}
		output.innerHTML = buffer
	})
}
const sanitize = (string) => string.replace(/</g,'&lt;').replace(/>/g,'&gt;')
const escape = (string) => string.replace(/[-_.!~*"'()]/g,char=>'&#'+char.charCodeAt()+';')
/**
 * Gfycat-like human-friendly ID generator
 * @returns {string} ID
 */
function makeID(){
	const adjectives = `abandoned,able,absolute,adorable,adventurous,academic,acceptable,acclaimed,accomplished,accurate,aching,acidic,acrobatic,active,actual,adept,admirable,admired,adolescent,adorable,adored,advanced,afraid,affectionate,aged,aggravating,aggressive,agile,agitated,agonizing,agreeable,ajar,alarmed,alarming,alert,alienated,alive,all,altruistic,amazing,ambitious,ample,amused,amusing,anchored,ancient,angelic,angry,anguished,animated,annual,another,antique,anxious,any,apprehensive,appropriate,apt,arctic,arid,aromatic,artistic,ashamed,assured,astonishing,athletic,attached,attentive,attractive,austere,authentic,authorized,automatic,avaricious,average,aware,awesome,awful,awkward,babyish,bad,back,baggy,bare,barren,basic,beautiful,belated,beloved,beneficial,better,best,bewitched,big,big-hearted,biodegradable,bite-sized,bitter,black,black-and-white,bland,blank,blaring,bleak,blind,blissful,blond,blue,blushing,bogus,boiling,bold,bony,boring,bossy,both,bouncy,bountiful,bowed,brave,breakable,brief,bright,brilliant,brisk,broken,bronze,brown,bruised,bubbly,bulky,bumpy,buoyant,burdensome,burly,bustling,busy,buttery,buzzing,calculating,calm,candid,canine,capital,carefree,careful,careless,caring,cautious,cavernous,celebrated,charming,cheap,cheerful,cheery,chief,chilly,chubby,circular,classic,clean,clear,clear-cut,clever,close,closed,cloudy,clueless,clumsy,cluttered,coarse,cold,colorful,colorless,colossal,comfortable,common,compassionate,competent,complete,complex,complicated,composed,concerned,concrete,confused,conscious,considerate,constant,content,conventional,cooked,cool,cooperative,coordinated,corny,corrupt,costly,courageous,courteous,crafty,crazy,creamy,creative,creepy,criminal,crisp,critical,crooked,crowded,cruel,crushing,cuddly,cultivated,cultured,cumbersome,curly,curvy,cute,cylindrical,damaged,damp,dangerous,dapper,daring,darling,dark,dazzling,dead,deadly,deafening,dear,dearest,decent,decimal,decisive,deep,defenseless,defensive,defiant,deficient,definite,definitive,delayed,delectable,delicious,delightful,delirious,demanding,dense,dental,dependable,dependent,descriptive,deserted,detailed,determined,devoted,different,difficult,digital,diligent,dim,dimpled,dimwitted,direct,disastrous,discrete,disfigured,disgusting,disloyal,dismal,distant,downright,dreary,dirty,disguised,dishonest,dismal,distant,distinct,distorted,dizzy,dopey,doting,double,downright,drab,drafty,dramatic,dreary,droopy,dry,dual,dull,dutiful,each,eager,earnest,early,easy,easy-going,ecstatic,edible,educated,elaborate,elastic,elated,elderly,electric,elegant,elementary,elliptical,embarrassed,embellished,eminent,emotional,empty,enchanted,enchanting,energetic,enlightened,enormous,enraged,entire,envious,equal,equatorial,essential,esteemed,ethical,euphoric,even,evergreen,everlasting,every,evil,exalted,excellent,exemplary,exhausted,excitable,excited,exciting,exotic,expensive,experienced,expert,extraneous,extroverted,extra-large,extra-small,fabulous,failing,faint,fair,faithful,fake,false,familiar,famous,fancy,fantastic,far,faraway,far-flung,far-off,fast,fat,fatal,fatherly,favorable,favorite,fearful,fearless,feisty,feline,female,feminine,few,fickle,filthy,fine,finished,firm,first,firsthand,fitting,fixed,flaky,flamboyant,flashy,flat,flawed,flawless,flickering,flimsy,flippant,flowery,fluffy,fluid,flustered,focused,fond,foolhardy,foolish,forceful,forked,formal,forsaken,forthright,fortunate,fragrant,frail,frank,frayed,free,French,fresh,frequent,friendly,frightened,frightening,frigid,frilly,frizzy,frivolous,front,frosty,frozen,frugal,fruitful,full,fumbling,functional,funny,fussy,fuzzy,gargantuan,gaseous,general,generous,gentle,genuine,giant,giddy,gigantic,gifted,giving,glamorous,glaring,glass,gleaming,gleeful,glistening,glittering,gloomy,glorious,glossy,glum,golden,good,good-natured,gorgeous,graceful,gracious,grand,grandiose,granular,grateful,grave,gray,great,greedy,green,gregarious,grim,grimy,gripping,grizzled,gross,grotesque,grouchy,grounded,growing,growling,grown,grubby,gruesome,grumpy,guilty,gullible,gummy,hairy,half,handmade,handsome,handy,happy,happy-go-lucky,hard,hard-to-find,harmful,harmless,harmonious,harsh,hasty,hateful,haunting,healthy,heartfelt,hearty,heavenly,heavy,hefty,helpful,helpless,hidden,hideous,high,high-level,hilarious,hoarse,hollow,homely,honest,honorable,honored,hopeful,horrible,hospitable,hot,huge,humble,humiliating,humming,humongous,hungry,hurtful,husky,icky,icy,ideal,idealistic,identical,idle,idiotic,idolized,ignorant,ill,illegal,ill-fated,ill-informed,illiterate,illustrious,imaginary,imaginative,immaculate,immaterial,immediate,immense,impassioned,impeccable,impartial,imperfect,imperturbable,impish,impolite,important,impossible,impractical,impressionable,impressive,improbable,impure,inborn,incomparable,incompatible,incomplete,inconsequential,incredible,indelible,inexperienced,indolent,infamous,infantile,infatuated,inferior,infinite,informal,innocent,insecure,insidious,insignificant,insistent,instructive,insubstantial,intelligent,intent,intentional,interesting,internal,international,intrepid,ironclad,irresponsible,irritating,itchy,jaded,jagged,jam-packed,jaunty,jealous,jittery,joint,jolly,jovial,joyful,joyous,jubilant,judicious,juicy,jumbo,junior,jumpy,juvenile,kaleidoscopic,keen,key,kind,kindhearted,kindly,klutzy,knobby,knotty,knowledgeable,knowing,known,kooky,kosher,lame,lanky,large,last,lasting,late,lavish,lawful,lazy,leading,lean,leafy,left,legal,legitimate,light,lighthearted,likable,likely,limited,limp,limping,linear,lined,liquid,little,live,lively,livid,loathsome,lone,lonely,long,long-term,loose,lopsided,lost,loud,lovable,lovely,loving,low,loyal,lucky,lumbering,luminous,lumpy,lustrous,luxurious,mad,made-up,magnificent,majestic,major,male,mammoth,married,marvelous,masculine,massive,mature,meager,mealy,mean,measly,meaty,medical,mediocre,medium,meek,mellow,melodic,memorable,menacing,merry,messy,metallic,mild,milky,mindless,miniature,minor,minty,miserable,miserly,misguided,misty,mixed,modern,modest,moist,monstrous,monthly,monumental,moral,mortified,motherly,motionless,mountainous,muddy,muffled,multicolored,mundane,murky,mushy,musty,muted,mysterious,naive,narrow,nasty,natural,naughty,nautical,near,neat,necessary,needy,negative,neglected,negligible,neighboring,nervous,new,next,nice,nifty,nimble,nippy,nocturnal,noisy,nonstop,normal,notable,noted,noteworthy,novel,noxious,numb,nutritious,nutty,obedient,obese,oblong,oily,oblong,obvious,occasional,odd,oddball,offbeat,offensive,official,old,old-fashioned,only,open,optimal,optimistic,opulent,orange,orderly,organic,ornate,ornery,ordinary,original,other,our,outlying,outgoing,outlandish,outrageous,outstanding,oval,overcooked,overdue,overjoyed,overlooked,palatable,pale,paltry,parallel,parched,partial,passionate,past,pastel,peaceful,peppery,perfect,perfumed,periodic,perky,personal,pertinent,pesky,pessimistic,petty,phony,physical,piercing,pink,pitiful,plain,plaintive,plastic,playful,pleasant,pleased,pleasing,plump,plush,polished,polite,political,pointed,pointless,poised,poor,popular,portly,posh,positive,possible,potable,powerful,powerless,practical,precious,present,prestigious,pretty,precious,previous,pricey,prickly,primary,prime,pristine,private,prize,probable,productive,profitable,profuse,proper,proud,prudent,punctual,pungent,puny,pure,purple,pushy,putrid,puzzled,puzzling,quaint,qualified,quarrelsome,quarterly,queasy,querulous,questionable,quick,quick-witted,quiet,quintessential,quirky,quixotic,quizzical,radiant,ragged,rapid,rare,rash,raw,recent,reckless,rectangular,ready,real,realistic,reasonable,red,reflecting,regal,regular,reliable,relieved,remarkable,remorseful,remote,repentant,required,respectful,responsible,repulsive,revolving,rewarding,rich,rigid,right,ringed,ripe,roasted,robust,rosy,rotating,rotten,rough,round,rowdy,royal,rubbery,rundown,ruddy,rude,runny,rural,rusty,sad,safe,salty,same,sandy,sane,sarcastic,sardonic,satisfied,scaly,scarce,scared,scary,scented,scholarly,scientific,scornful,scratchy,scrawny,second,secondary,second-hand,secret,self-assured,self-reliant,selfish,sentimental,separate,serene,serious,serpentine,several,severe,shabby,shadowy,shady,shallow,shameful,shameless,sharp,shimmering,shiny,shocked,shocking,shoddy,short,short-term,showy,shrill,shy,sick,silent,silky,silly,silver,similar,simple,simplistic,sinful,single,sizzling,skeletal,skinny,sleepy,slight,slim,slimy,slippery,slow,slushy,small,smart,smoggy,smooth,smug,snappy,snarling,sneaky,sniveling,snoopy,sociable,soft,soggy,solid,somber,some,spherical,sophisticated,sore,sorrowful,soulful,soupy,sour,Spanish,sparkling,sparse,specific,spectacular,speedy,spicy,spiffy,spirited,spiteful,splendid,spotless,spotted,spry,square,squeaky,squiggly,stable,staid,stained,stale,standard,starchy,stark,starry,steep,sticky,stiff,stimulating,stingy,stormy,straight,strange,steel,strict,strident,striking,striped,strong,studious,stunning,stupendous,stupid,sturdy,stylish,subdued,submissive,substantial,subtle,suburban,sudden,sugary,sunny,super,superb,superficial,superior,supportive,sure-footed,surprised,suspicious,svelte,sweaty,sweet,sweltering,swift,sympathetic,tall,talkative,tame,tan,tangible,tart,tasty,tattered,taut,tedious,teeming,tempting,tender,tense,tepid,terrible,terrific,testy,thankful,that,these,thick,thin,third,thirsty,this,thorough,thorny,those,thoughtful,threadbare,thrifty,thunderous,tidy,tight,timely,tinted,tiny,tired,torn,total,tough,traumatic,treasured,tremendous,tragic,trained,tremendous,triangular,tricky,trifling,trim,trivial,troubled,true,trusting,trustworthy,trusty,truthful,tubby,turbulent,twin,ugly,ultimate,unacceptable,unaware,uncomfortable,uncommon,unconscious,understated,unequaled,uneven,unfinished,unfit,unfolded,unfortunate,unhappy,unhealthy,uniform,unimportant,unique,united,unkempt,unknown,unlawful,unlined,unlucky,unnatural,unpleasant,unrealistic,unripe,unruly,unselfish,unsightly,unsteady,unsung,untidy,untimely,untried,untrue,unused,unusual,unwelcome,unwieldy,unwilling,unwitting,unwritten,upbeat,upright,upset,urban,usable,used,useful,useless,utilized,utter,vacant,vague,vain,valid,valuable,vapid,variable,vast,velvety,venerated,vengeful,verifiable,vibrant,vicious,victorious,vigilant,vigorous,villainous,violet,violent,virtual,virtuous,visible,vital,vivacious,vivid,voluminous,wan,warlike,warm,warmhearted,warped,wary,wasteful,watchful,waterlogged,watery,wavy,wealthy,weak,weary,webbed,wee,weekly,weepy,weighty,weird,welcome,well-documented,well-groomed,well-informed,well-lit,well-made,well-off,well-to-do,well-worn,wet,which,whimsical,whirlwind,whispered,white,whole,whopping,wicked,wide,wide-eyed,wiggly,wild,willing,wilted,winding,windy,winged,wiry,wise,witty,wobbly,woeful,wonderful,wooden,woozy,wordy,worldly,worn,worried,worrisome,worse,worst,worthless,worthwhile,worthy,wrathful,wretched,writhing,wrong,wry,yawning,yearly,yellow,yellowish,young,youthful,yummy,zany,zealous,zesty,zigzag`
	.split(',')
	const animals = `aardvark,albatross,alligator,alpaca,ant,anteater,antelope,ape,armadillo,baboon,badger,barracuda,bat,bear,beaver,bee,bird,bison,boar,butterfly,camel,caribou,cassowary,cat,caterpillar,cattle,chamois,cheetah,chicken,chimpanzee,chinchilla,chough,coati,cobra,cockroach,cod,cormorant,coyote,crab,crocodile,crow,curlew,deer,dinosaur,dog,dolphin,donkey,dotterel,dove,dragonfly,duck,dugong,dunlin,eagle,echidna,eel,elephant,elk,emu,falcon,ferret,finch,fish,flamingo,fly,fox,frog,gaur,gazelle,gerbil,giraffe,gnat,goat,goose,gorilla,goshawk,grasshopper,grouse,guanaco,gull,hamster,hare,hawk,hedgehog,heron,herring,hippopotamus,hornet,horse,hummingbird,hyena,ibex,ibis,jackal,jaguar,jay,jellyfish,kangaroo,kinkajou,koala,kouprey,kudu,lapwing,lark,lemur,leopard,lion,llama,lobster,locust,loris,louse,lyrebird,magpie,mallard,manatee,mandrill,mink,mongoose,monkey,moose,mouse,mosquito,narwhal,newt,nightingale,octopus,okapi,opossum,ostrich,otter,owl,oyster,parrot,panda,partridge,peafowl,pelican,penguin,pheasant,pork,pigeon,pony,porcupine,porpoise,quail,quelea,quetzal,rabbit,raccoon,rat,raven,reindeer,rhinoceros,salamander,salmon,sandpiper,sardine,seahorse,shark,sheep,shrew,skunk,sloth,snail,snake,spider,squirrel,starling,swan,tapir,tarsier,termite,tiger,toad,turtle,wallaby,walrus,wasp,weasel,whale,wolf,wolverine,wombat,wren,yak,zebra`
	.split(',')
	
	return [randomElement(adjectives),randomElement(adjectives),randomElement(animals)].join('-')
}
/**
 * Initiates a textarea
 * @param {Element} $textarea
 */
async function initTextarea($textarea){
	// reset default attributes
	$textarea.setAttribute('rows',1)

	// on input, adjust the <textarea>'s display height to that of its contents
	$textarea.addEventListener('input',()=>{
		$textarea.style.height = 'auto'
		$textarea.style.height = $textarea.scrollHeight+'px'
	})

	// unless the textarea is multi-line, make the enter key trigger the 'change' event
	remapEnter($textarea, $textarea.hasAttribute('multi-line'))

	// if the window resizes horizontally, update the textarea's display heights
	window.addEventListener('resize',()=>{
		if(window.oldInnerWidth !== window.innerWidth) {
			$$('textarea').forEach(dispatchInput)
			window.oldInnerWidth = window.innerWidth
		}
	})
}
/**
 * Programmatically trigger the 'input' event on an element
 * @param {Element} $element
 */
async function dispatchInput($element){
	$element.dispatchEvent(new Event('input'))
}
/**
 * Programmatically trigger the 'change' event on an element
 * @param {Element} $element 
 */
async function dispatchChange($element){
	$element.dispatchEvent(new Event('change', { bubbles: true } ))
}
/**
 * Assign the enter key to trigger the 'change' event
 * @param {Element} $input 
 */
function remapEnter($input,needCtrl=false){
	$input.addEventListener('keydown',event=>{
		if( event.key!=='Enter' || ( needCtrl && !event.ctrlKey ) ) return
		event.preventDefault()
		$input.blur()
		return false
	})
}
// The MIT License (MIT)

// Copyright (c) 2016 Sultan Tarimo

// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:

// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

/*!
 *             __
 *   __ _  ___/ /
 *  /  ' \/ _  / 
 * /_/_/_/\_,_/ 
 * 
 * md.js is a lightweight markdown parser
 * https://github.com/thysultan/md.js
 * 
 * @licence MIT
 */
(function (factory) {
	if (typeof exports === 'object' && typeof module !== 'undefined') {
		module.exports = factory();
	} else if (typeof define === 'function' && define.amd) {
		define(factory());
	} else {
		window.md = factory();
	}
}(function () {
	var unicodes = {
		'<': '&lt;',
		'>': '&gt;',
		'"': '&quot;',
		"'": '&#39;',
		'&': '&amp;',
		'[': '&#91;',
		']': '&#93;',
		'(': '&#40;',
		')': '&#41;',
	};

	var resc = /[<>&\(\)\[\]"']/g;

	function unicode (char) { return unicodes[char] || char; }

	var XSSFilterRegExp = /<(script)[^\0]*?>([^\0]+?)<\/(script)>/gmi;
	var XSSFilterTemplate = '&lt;$1&gt;$2&lt;/$3&gt;';

	var XSSFilterInlineJSRegExp = /(<.*? [^\0]*?=[^\0]*?)(javascript:.*?)(.*>)/gmi;
	var XSSFilterInlineJSTemplate = '$1#$2&#58;$3';

	var XSSFilterImageRegExp = /<img([^\0]*?onerror=)([^\0]*?)>/gmi;
	var XSSFilterImageTemplate = function (match, group1, group2) {
		return '<img' + group1 + group2.replace(resc, unicode) + '>';
	};

	var removeTabsRegExp = /^[\t ]+|[\t ]$/gm;

	var htmlFilterRegExp = /(<.*>[\t ]*\n^.*)/gm;
	var htmlFilterTemplate = function (match, group1) { 
		return group1.replace(/^\n|$\n/gm, '');
	};

	var cssFilterRegExp = /(<style>[^]*<\/style>)/gm;
	var cssFilterTemplate = htmlFilterTemplate;

	var eventsFilterRegExp = /(<[^]+?)(on.*?=.*?)(.*>)/gm;
	var eventsFilterTemplate = '$1$3';

	var blockQuotesRegExp = /^[ \t]*> (.*)/gm;
	var blockQuotesTemplate = '<blockquote>$1</blockquote>';

	var inlineCodeRegExp = /`([^`]+?)`/g;
	var inlineCodeTemplate = function (match, group1) {
		return '<code>'+group1.replace(resc, unicode)+'</code>'
	}

	var blockCodeRegExp = /```(.*)\n([^\0]+?)```(?!```)/gm;

	var imagesRegExp = /!\[(.*)\]\((.*)\)/g;
	var imagesTemplate = function (match, group1, group2) {
		var src = group2.replace(resc, unicode);
		var alt = group1.replace(resc, unicode);

		return '<img src="'+src+'" alt="'+alt+'">';
	};

	var headingsRegExp = /^(#+) +(.*)/gm;
	var headingsTemplate = function (match, hash, content) {
		var length = hash.length; return '<h'+length+'>'+content+'</h'+length+'>';
	};

	var headingsCommonh2RegExp = /^([^\n\t ])(.*)\n----+/gm;
	var headingsCommonh1RegExp = /^([^\n\t ])(.*)\n====+/gm;
	var headingsCommonh1Template = '<h1>$1$2</h1>';
	var headingsCommonh2Template = '<h2>$1$2</h2>';

	var paragraphsRegExp = /^([^-><#\d\+\_\*\t\n\[\! \{])([^]*?)(|  )(?:\n\n)/gm;
	var paragraphsTemplate = function (match, group1, group2, group3) {
		var leadingCharater = group1;
		var body = group2;
		
		var trailingSpace = group3 ? '\n<br>\n' : '\n';
		return '<p>'+leadingCharater+body+'</p>'+trailingSpace;
	};

	var horizontalRegExp = /^.*?(?:---|\*\*\*|- - -|\* \* \*)/gm;
	var horizontalTemplate = '<hr>';

	var strongRegExp = /(?:\*\*|\_\_)([^\*\n_]+?)(?:\*\*|\_\_)/g;
	var strongTemplate = '<strong>$1</strong>';

	var emphasisRegExp = /(?:\*|\_)([^\*\n_]+?)(?:\*|\_)/g;
	var emphasisTemplate = '<em>$1</em>';

	var strikeRegExp = /(?:~~)([^~]+?)(?:~~)/g;
	var strikeTemplate = '<del>$1</del>';

	var linksRegExp = /\[(.*?)\]\(([^\t\n ]*)(?:| "(.*)")\)+/gm;
	var linksTemplate = function (match, group1, group2, group3) {
		var link = group2.replace(resc, unicode);
		var text = group1.replace(resc, unicode);
		var title = group3 ? ' title="'+group3.replace(resc, unicode)+'"' : '';

		return '<a href="'+link+'"'+title+'>'+text+'</a>';
	};

	var listUlRegExp1 = /^[\t ]*?(?:-|\+|\*) (.*)/gm;
	var listUlRegExp2 = /(\<\/ul\>\n(.*)\<ul\>*)+/g;
	var listUlTemplate = '<ul><li>$1</li></ul>';

	var listOlRegExp1 = /^[\t ]*?(?:\d(?:\)|\.)) (.*)/gm;
	var listOlRegExp2 = /(\<\/ol\>\n(.*)\<ol\>*)+/g;
	var listOlTemplate = '<ol><li>$1</li></ol>';

	var lineBreaksRegExp = /^\n\n+/gm;
	var lineBreaksTemplate = '<br>';

	var checkBoxesRegExp = /\[( |x)\]/g;
	var checkBoxesTemplate = function (match, group1) {
		return '<input type="checkbox" disabled' + (group1.toLowerCase() === 'x' ? ' checked' : '') + '>'
	};


	/**
	 * markdown parser
	 * 
	 * @param  {string} markdown
	 * @return {string}
	 */
	function md (markdown) {
		if (!markdown) {
			return '';
		}

		var code = [];
		var index = 0;
		var length = markdown.length;

		// to allow matching trailing paragraphs
		if (markdown[length-1] !== '\n' && markdown[length-2] !== '\n') {
			markdown += '\n\n';
		}

		// format, removes tabs, leading and trailing spaces
		markdown = (
			markdown
				// expand url shorthand
				.replace(/(\(\/\/)/g,'(https://')
				// turn raw email addresses into email links.
				.replace(/<(\S+@\S+)>/g,'[$1](mailto:$1)')
				// turn raw URLs into links.
				.replace(/<(https?:\/\/)?(\S+)>/g,'[$2](https://$2)')
				// collect code blocks and replace with placeholder
				// we do this to avoid code blocks matching the paragraph regexp
				.replace(blockCodeRegExp, function (match, lang, block) {
					var placeholder = '{code-block-'+index+'}';
					var regex = new RegExp('{code-block-'+index+'}', 'g');

					code[index++] = {lang: lang, block: block.replace(resc, unicode), regex: regex};

					return placeholder;
				})
				// XSS script tags
				.replace(XSSFilterRegExp, XSSFilterTemplate)
				// XSS image onerror
				.replace(XSSFilterImageRegExp, XSSFilterImageTemplate)
				// filter events
				.replace(eventsFilterRegExp, eventsFilterTemplate)
				// tabs
				.replace(removeTabsRegExp, "")
				// blockquotes
				.replace(blockQuotesRegExp, blockQuotesTemplate)
				// images
				.replace(imagesRegExp, imagesTemplate)
				// headings
				.replace(headingsRegExp, headingsTemplate)
				// headings h1 (commonmark)
				.replace(headingsCommonh1RegExp, headingsCommonh1Template)
				// headings h2 (commonmark)
				.replace(headingsCommonh2RegExp, headingsCommonh2Template)
				// horizontal rule 
				.replace(horizontalRegExp, horizontalTemplate)
				// checkboxes
				.replace(checkBoxesRegExp, checkBoxesTemplate)
				// filter html
				.replace(htmlFilterRegExp, htmlFilterTemplate)
				// filter css
				.replace(cssFilterRegExp, cssFilterTemplate)
				// paragraphs
				.replace(paragraphsRegExp, paragraphsTemplate)
				// inline code
				.replace(inlineCodeRegExp, inlineCodeTemplate)
				// links
				.replace(linksRegExp, linksTemplate)
				// unorderd lists
				.replace(listUlRegExp1, listUlTemplate).replace(listUlRegExp2, "")
				// ordered lists
				.replace(listOlRegExp1, listOlTemplate).replace(listOlRegExp2, "")
				// strong
				.replace(strongRegExp, strongTemplate)
				// emphasis
				.replace(emphasisRegExp, emphasisTemplate)
				// strike through
				.replace(strikeRegExp, strikeTemplate)
				// line breaks
				.replace(lineBreaksRegExp, lineBreaksTemplate)
				// filter inline js
				.replace(XSSFilterInlineJSRegExp, XSSFilterInlineJSTemplate)
		);

		// replace code block placeholders
		for (var i = 0; i < index; i++) {
			var item = code[i];
			var lang = item.lang;
			var block = item.block;

			markdown = markdown.replace(item.regex, function (match) {
				return '<pre><code class="language-'+lang+'">'+block+'</code></pre>';
			});
		}

		return markdown.trim();
	}

	return md;
}));
/**
 * Sends an HTTP GET request
 * @param {string} path 
 * @param {Object} request 
 * @returns {json} response
 */
const post = async ( path, request ) => fetch(
	'https://'+path,
	{
		body: JSON.stringify(request),
		headers: { 'Content-Type': 'application/json' },
		method: 'POST',
	}	
)

/**
 * @typedef {Object} urlSet
 * @property {string} imageURL URL of full image
 * @property {string} thumbURL URL of thumbnail
 */

/**
 * Uploads an image to ImgBB.com
 * @param {*} data URL or image file
 * @returns {urlSet}
 */
const imgbb = async ( data ) => {
	const body = new FormData()
	body.append('image',data)
	const response = await fetch(
		'https://' + await dbOnce('secrets/imgbb'),
		{ method: 'POST', body }
	)
	const { data: { image, medium, thumb } } = await response.json()
	return {
		imageURL: medium ? medium.url : image.url,
		thumbURL: thumb.url,
	}
}

/**
 * Expands relative path to Firebase realtime database URL
 * @param {string} path Relative path
 * @param {boolean} legacy Use legacy database
 * @returns {string} full path
 */
const dbPath = ( path, legacy ) => (
	'https://'+
	(legacy ? 'arcadia-high-mobile' : 'ahs-app')+
	'.firebaseio.com/'+
	path+
	'.json'+
	token
)

const db = async ( path='', request={}, legacy=false ) => ( await fetch( dbPath(path, legacy), request ) ).json()

/**
 * Reads a cached database
 * @param {string} path 
 * @returns {Promise} response
 */
 const dbCache = async ( path ) => db( path, {
	 headers: { Aces: 'cache' }
 } )

/**
 * Reads the database and updates it live
 * @param {string} path 
 * @returns {Promise} response
 */
const dbLive = async ( path ) => db( path, { 
	headers: { Aces: 'live' } 
})

/**
 * Reads the database once
 * @param {string} path 
 * @returns {Promise} response
 */
const dbOnce = async ( path ) => db( path, {
	headers: { Aces: 'once' }
} )

/**
 * Writes to the database
 * @param {string} path 
 * @param {Object} body 
 * @param {boolean} legacy Use legacy database
 * @returns {Promise} return
 */
const dbWrite = async ( path, body, legacy ) => user ? db( path, {
	body: JSON.stringify(body),
	headers: { 'Content-Type': 'application/json' },
	method: 'PATCH',
}, legacy ) : false

/**
 * 
 * @param {string} path 
 * @param {Object} request 
 * @returns {Promise} response
 */
const googleapis = async (path,request) => (await post(path+'?key='+KEY,request)).json()
/**
 * Initiates the resize bar
 */
async function initResize(){
	// resize bar
	const $resize = $('#resize')

	// left panel
	const $editor = $('#editor')

	// focus the resize bar if a mouse clicks or finger touches it 
	$resize.addEventListener('pointerdown',()=>$resize.focus())

	// watch for mouse or finger movement
	window.addEventListener('pointermove',(event)=>{
		// checks if the resize bar is focused, if not then do nothing
		if($resize !== document.activeElement) return
		
		// resize the left panel so the resize bar is horizontally centered under the pointer
		$editor.style.width = (event.x-$resize.offsetWidth/2)/window.innerWidth*100+'vw'
		
		// the resized textareas need to have their line wrapping adjusted
		$$('textarea').forEach(dispatchInput)
		
		// prevent default behaviors which may accidentally other stuff
		event.preventDefault()
	})

	// unfocus the resize bar if the mouse click or finger dragging ends
	window.addEventListener('pointerup',()=>$resize.blur())
}
const typography = text => text
		// Smart quotes
		/* opening singles */
		.replace(/(^|[-\u2014\s(\["])'/g,'$1‘')
		/* closing singles & apostrophes */
		.replace(/'/g,'’')
		/* opening doubles */
		.replace(/(^|[-\u2014/\[(\u2018\s])"/g,'$1“')
		/* closing doubles */
		.replace(/"/g,'”')
	// Dashes
		/* em-dashes */
		.replace(/\s--\s?/g,' — ')
		/* en-dashes */
		.replace(/--/g,'–')
const timestamp = () => Math.trunc(Date.now()/1000/60)*60

/**
 * Shifts every character 13 places down the alphabet; swaps - and .
 * @param {string} string 
 * @returns {string}
 */
const rot13 = string => string.replace(/[a-z]/gi,c=>'NOPQRSTUVWXYZABCDEFGHIJKLMnopqrstuvwxyzabcdefghijklm.-'['ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-.'.indexOf(c)])

/**
 * Brackets an ID by its type
 * @param {string} id 
 * @param {string} type
 * @returns {string} bracketed ID
 */
const bracket = (id,type) => {
	let brackets = type == 'location' ? '{}'
	: type == 'category' ? '[]'
	: type == 'article' ? '<>'
	: '""'
	return brackets[0] + id + brackets[1]	
}

/**
 * 
 * @returns {number} Timezone offset in seconds
 */
const timezoneOffset = () => new Date().getTimezoneOffset()*60

/**
 * 
 * @param {number} timestamp Unix timestamp in seconds 
 * @returns {Date} Date object
 */
const timestampToLocalDate = timestamp => new Date((parseInt(timestamp) - timezoneOffset())*1000)

const timestampToLocalISOString = timestamp => timestampToLocalDate(timestamp).toISOString().slice(0,19)

const timestampToLocalHumanString = timestamp => timestampToLocalDate(timestamp).toLocaleDateString(undefined, {
	weekday: 'long',
	month: 'long',
	day: 'numeric'
})

/**
 * 
 * @param {string} ISOString ISO datetime string
 * @returns {number} Unix timestamp in seconds 
 */
const LocalISOStringToTimestamp = ISOString => Math.trunc(new Date(ISOString+'Z').getTime()/1000) + timezoneOffset()


/**
 * 
 * @param {array} array array
 * @returns {*} random element of the array
 */
const randomElement = array => array[Math.floor(Math.random()*array.length)]

const urlID = () => {
	let id = window.location.pathname.split('/').pop() // Last portion of the path is the ID
	if (id.includes('.')) id = rot13(id) // A . indicates that the ID is ciphered.
	if (!id.includes('-')) id = makeID()
	return id
}

/**
 * Returns list of properties whose values are different between two objects 
 * @param {Object} a 
 * @param {Object} b 
 * @returns {Array}
 */
const diff = (a,b) => Object.keys({ ...a, ...b })
.filter( k => JSON.stringify(a[k]||0) !== JSON.stringify(b[k]||0) )

/**
 * Returns a formatted list of properties and their before and after values
 * @param {Object} a 
 * @param {Object} b 
 * @returns {String}
 */
const formattedDiff = (a,b) => diff(a,b)
.map( k =>
  [k,a[k],b[k]]
  .map( s => s === undefined ? null : s )
  .map( JSON.stringify )
  .map( s => s.length > 16 ? s.substring(0,16) + '...' : s )
)
.map(([k,a,b])=>`${k}: ${a} → ${b}`)
.join('\n')
async function initWorker(){
	if (!('serviceWorker' in navigator)) return
	// navigator.serviceWorker.register('/worker.js')
	navigator.serviceWorker.subscriptionList = { }
	navigator.serviceWorker.addEventListener('message', ({data:{type,path}}) => {
		console.log(data)
		const list = navigator.serviceWorker.subscriptionList
		if(type=='update' && path in list) (list[path])()
	})
	navigator.serviceWorker.getRegistrations().then(function (registrations) {
		for (const registration of registrations) {
			// unregister service worker
			console.log('serviceWorker unregistered')
			registration.unregister()
		}
	})
}
initWorker()
initEditor()
initBrowser()
initResize()
initAuth()
		</script>
  </body>
</html>